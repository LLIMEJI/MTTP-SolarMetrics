#!/usr/bin/env ruby

require "bundler/setup"
require 'rmodbus'
require 'simple_config'
require 'mysql2'
require 'logging'

logger = Logging.logger['example_logger']
logger.level = :info

logger.add_appenders \
    Logging.appenders.stdout,
    Logging.appenders.file('indicators.log')

ModBus::TCPClient.new(SimpleConfig.modbus.host, SimpleConfig.modbus.port) do |cl|
  cl.with_slave(1) do |slave|
    @sweep_pmax = slave.holding_registers[60][0]
  end
end

client = Mysql2::Client.new :host => SimpleConfig.mysql.host,
                            :username => SimpleConfig.mysql.user,
                            :password => SimpleConfig.mysql.pass,
                            :database => SimpleConfig.mysql.dbase
query = "INSERT INTO #{SimpleConfig.mysql.table} (value) values (#{@sweep_pmax})"
logger.info "QUERY: #{query}"
logger.info "PMAX: #{@sweep_pmax}"

client.query(query)
